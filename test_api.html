<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Olist Recommendation API - Teste de Rotas</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 30px;
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
      }

      .section h2 {
        color: #34495e;
        margin-top: 0;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
      }

      .endpoint {
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 5px;
        border-left: 4px solid #3498db;
      }

      .endpoint h3 {
        margin: 0 0 10px 0;
        color: #2c3e50;
      }

      .method {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 12px;
        margin-right: 10px;
      }

      .get {
        background: #27ae60;
        color: white;
      }
      .post {
        background: #e74c3c;
        color: white;
      }
      .put {
        background: #f39c12;
        color: white;
      }
      .delete {
        background: #e67e22;
        color: white;
      }

      .url {
        font-family: "Courier New", monospace;
        background: #ecf0f1;
        padding: 8px;
        border-radius: 4px;
        margin: 5px 0;
        word-break: break-all;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #34495e;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        font-size: 14px;
      }

      button {
        background: #3498db;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
      }

      button:hover {
        background: #2980b9;
      }

      .response {
        margin-top: 15px;
        padding: 15px;
        background: #2c3e50;
        color: #ecf0f1;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }

      .success {
        background: #27ae60;
      }
      .error {
        background: #e74c3c;
      }

      .auth-section {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .token-display {
        font-family: "Courier New", monospace;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üõí Olist Recommendation API - Teste de Rotas</h1>

      <!-- Configura√ß√£o da API -->
      <div class="section">
        <h2>‚öôÔ∏è Configura√ß√£o</h2>
        <div class="form-group">
          <label for="baseUrl">URL Base da API:</label>
          <input type="text" id="baseUrl" value="http://localhost:8000" />
        </div>
      </div>

      <!-- Autentica√ß√£o -->
      <div class="section">
        <h2>üîê Autentica√ß√£o</h2>
        <div class="auth-section">
          <p>
            <strong>Token Atual:</strong>
            <div class="token-display" id="currentToken">Nenhum token configurado</div>
          </p>
          <div class="token-display" id="tokenDisplay" style="display: none">
            <strong>Token:</strong> <span id="currentToken"></span>
          </div>
        </div>

        <div class="endpoint">
          <h3><span class="method post">POST</span> Login</h3>
          <div class="url">/auth/token</div>
          <div class="form-group">
            <label for="username">Email:</label>
            <input type="email" id="username" value="lalamagi@gmail.com" />
          </div>
          <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" value="lalamagi" />
          </div>
          <button onclick="login()">Login</button>
          <button onclick="debugLogin()" style="background-color: #f39c12;">Debug Login</button>
          <div class="response" id="loginResponse" style="display: none"></div>
        </div>

        <div class="endpoint">
          <h3><span class="method post">POST</span> Registro</h3>
          <div class="url">/auth/register</div>
          <div class="form-group">
            <label for="regEmail">Email:</label>
            <input type="email" id="regEmail" value="newuser@example.com" />
          </div>
          <div class="form-group">
            <label for="regFullName">Nome Completo (opcional):</label>
            <input type="text" id="regFullName" value="Novo Usu√°rio" />
          </div>
          <div class="form-group">
            <label for="regPassword">Password:</label>
            <input type="password" id="regPassword" value="newpassword" />
          </div>
          <button onclick="register()">Registrar</button>
          <div class="response" id="registerResponse" style="display: none"></div>
        </div>
      </div>

      <!-- Recomenda√ß√µes -->
      <div class="section">
        <h2>üéØ Recomenda√ß√µes</h2>

        <div class="endpoint">
          <h3><span class="method get">GET</span> Recomenda√ß√µes do Usu√°rio</h3>
          <div class="url">/recommendations/user/{user_id}</div>
          <div class="form-group">
            <label for="userId">ID do Usu√°rio:</label>
            <input type="text" id="userId" value="123" />
          </div>
          <div class="form-group">
            <label for="userLimit">Limite:</label>
            <input type="number" id="userLimit" value="10" />
          </div>
          <div class="form-group">
            <label for="strategy">Estrat√©gia:</label>
            <select id="strategy">
              <option value="collaborative">Colaborativa</option>
              <option value="content">Baseada em Conte√∫do</option>
              <option value="hybrid">H√≠brida</option>
            </select>
          </div>
          <button onclick="getUserRecommendations()">Buscar Recomenda√ß√µes</button>
          <div class="response" id="userRecommendationsResponse" style="display: none"></div>
        </div>

        <div class="endpoint">
          <h3><span class="method get">GET</span> Produtos Populares</h3>
          <div class="url">/recommendations/popular</div>
          <div class="form-group">
            <label for="popularLimit">Limite:</label>
            <input type="number" id="popularLimit" value="10" />
          </div>
          <div class="form-group">
            <label for="state">Estado (opcional):</label>
            <input type="text" id="state" value="" placeholder="SP, RJ, etc." />
          </div>
          <button onclick="getPopularProducts()">Buscar Populares</button>
          <div class="response" id="popularResponse" style="display: none"></div>
        </div>

        <div class="endpoint">
          <h3><span class="method get">GET</span> Produtos Relacionados</h3>
          <div class="url">/recommendations/related/{product_id}</div>
          <div class="form-group">
            <label for="productId">ID do Produto:</label>
            <input type="text" id="productId" value="abc123" />
          </div>
          <div class="form-group">
            <label for="relatedLimit">Limite:</label>
            <input type="number" id="relatedLimit" value="5" />
          </div>
          <button onclick="getRelatedProducts()">Buscar Relacionados</button>
          <div class="response" id="relatedResponse" style="display: none"></div>
        </div>

        <div class="endpoint">
          <h3><span class="method get">GET</span> Recomenda√ß√µes Sazonais</h3>
          <div class="url">/recommendations/seasonal</div>
          <div class="form-group">
            <label for="month">M√™s:</label>
            <input type="number" id="month" value="12" min="1" max="12" />
          </div>
          <div class="form-group">
            <label for="seasonalLimit">Limite:</label>
            <input type="number" id="seasonalLimit" value="10" />
          </div>
          <button onclick="getSeasonalRecommendations()">Buscar Sazonais</button>
          <div class="response" id="seasonalResponse" style="display: none"></div>
        </div>

        <div class="endpoint">
          <h3><span class="method get">GET</span> Produtos Mais Bem Avaliados</h3>
          <div class="url">/recommendations/top-rated</div>
          <div class="form-group">
            <label for="minReviews">M√≠nimo de Avalia√ß√µes:</label>
            <input type="number" id="minReviews" value="10" />
          </div>
          <div class="form-group">
            <label for="ratedLimit">Limite:</label>
            <input type="number" id="ratedLimit" value="10" />
          </div>
          <button onclick="getTopRatedProducts()">Buscar Mais Bem Avaliados</button>
          <div class="response" id="topRatedResponse" style="display: none"></div>
        </div>
      </div>

      <!-- Analytics -->
      <div class="section">
        <h2>üìä Analytics</h2>

        <div class="endpoint">
          <h3><span class="method get">GET</span> M√©tricas Gerais</h3>
          <div class="url">/analytics/metrics</div>
          <button onclick="getMetrics()">Buscar M√©tricas</button>
          <div class="response" id="metricsResponse" style="display: none"></div>
        </div>

        <div class="endpoint">
          <h3><span class="method get">GET</span> Categorias Populares</h3>
          <div class="url">/analytics/popular-categories</div>
          <button onclick="getPopularCategories()">Buscar Categorias</button>
          <div class="response" id="categoriesResponse" style="display: none"></div>
        </div>

        <div class="endpoint">
          <h3><span class="method get">GET</span> Comportamento do Usu√°rio</h3>
          <div class="url">/analytics/user-behavior/{user_id}</div>
          <div class="form-group">
            <label for="behaviorUserId">ID do Usu√°rio:</label>
            <input type="text" id="behaviorUserId" value="123" />
          </div>
          <button onclick="getUserBehavior()">Buscar Comportamento</button>
          <div class="response" id="behaviorResponse" style="display: none"></div>
        </div>
      </div>

      <!-- Sa√∫de da API -->
      <div class="section">
        <h2>‚ù§Ô∏è Sa√∫de da API</h2>

        <div class="endpoint">
          <h3><span class="method get">GET</span> Status da API</h3>
          <div class="url">/health</div>
          <button onclick="checkHealth()">Verificar Sa√∫de</button>
          <div class="response" id="healthResponse" style="display: none"></div>
        </div>
      </div>
    </div>

    <script>
      let authToken = "";

      function getBaseUrl() {
        return document.getElementById("baseUrl").value;
      }

      function getAuthHeaders() {
        return authToken ? { Authorization: `Bearer ${authToken}` } : {};
      }

      function displayResponse(elementId, response, isError = false) {
        const element = document.getElementById(elementId);
        element.style.display = "block";
        element.className = `response ${isError ? "error" : "success"}`;
        element.textContent = JSON.stringify(response, null, 2);
      }

      function updateTokenDisplay(token) {
        authToken = token;
        document.getElementById("currentToken").textContent = token
          ? token
          : "Nenhum token configurado";
        const tokenDisplay = document.getElementById("tokenDisplay");
        if (token) {
          tokenDisplay.style.display = "block";
        } else {
          tokenDisplay.style.display = "none";
        }
      }

      async function makeRequest(url, options = {}) {
        try {
          console.log(`[FRONTEND] makeRequest - URL: ${url}`);
          console.log(`[FRONTEND] makeRequest - Options:`, options);
          
          const defaultOptions = {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              ...getAuthHeaders(),
            },
          };

          const finalOptions = { ...defaultOptions, ...options };
          console.log(`[FRONTEND] makeRequest - Final options:`, finalOptions);

          const response = await fetch(url, finalOptions);
          const data = await response.json();

          console.log(`[FRONTEND] makeRequest - Response status: ${response.status}`);
          console.log(`[FRONTEND] makeRequest - Response data:`, data);

          return {
            success: response.ok,
            status: response.status,
            data: data,
          };
        } catch (error) {
          console.error(`[FRONTEND] makeRequest - Error:`, error);
          return {
            success: false,
            status: 0,
            data: { error: error.message },
          };
        }
      }

      // Fun√ß√£o de debug para teste
      async function debugLogin() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        console.log(`[FRONTEND] debugLogin - Username: '${username}'`);
        console.log(`[FRONTEND] debugLogin - Password length: ${password.length}`);

        const formData = new FormData();
        formData.append("username", username);
        formData.append("password", password);

        console.log(`[FRONTEND] debugLogin - FormData entries:`);
        for (let [key, value] of formData.entries()) {
          console.log(`[FRONTEND] debugLogin - ${key}: ${value}`);
        }

        try {
          const response = await fetch(`${getBaseUrl()}/auth/debug-token`, {
            method: "POST",
            body: formData,
          });

          const data = await response.json();
          console.log(`[FRONTEND] debugLogin - Response:`, data);
          
          displayResponse("loginResponse", data, !response.ok);
        } catch (error) {
          console.error(`[FRONTEND] debugLogin - Error:`, error);
        }
      }

      // Autentica√ß√£o
      async function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        console.log(`[FRONTEND] login - Username: '${username}'`);
        console.log(`[FRONTEND] login - Password length: ${password.length}`);

        if (!username || !password) {
          alert("Por favor, preencha email e senha");
          return;
        }

        // OAuth2PasswordRequestForm espera form data, n√£o JSON
        const formData = new FormData();
        formData.append("username", username);
        formData.append("password", password);

        console.log(`[FRONTEND] login - FormData entries:`);
        for (let [key, value] of formData.entries()) {
          console.log(`[FRONTEND] login - ${key}: ${value}`);
        }

        try {
          const response = await fetch(`${getBaseUrl()}/auth/token`, {
            method: "POST",
            body: formData,
          });

          console.log(`[FRONTEND] login - Response status: ${response.status}`);
          const data = await response.json();
          console.log(`[FRONTEND] login - Response data:`, data);

          const result = {
            success: response.ok,
            status: response.status,
            data: data,
          };

          if (result.success && result.data.access_token) {
            updateTokenDisplay(result.data.access_token);
          }

          displayResponse("loginResponse", result.data, !result.success);
        } catch (error) {
          console.error(`[FRONTEND] login - Fetch error:`, error);
          displayResponse("loginResponse", { error: error.message }, true);
        }
      }

      async function register() {
        const email = document.getElementById("regEmail").value;
        const fullName = document.getElementById("regFullName").value;
        const password = document.getElementById("regPassword").value;

        console.log(`[FRONTEND] register - Email: ${email}`);
        console.log(`[FRONTEND] register - Full name: ${fullName}`);
        console.log(`[FRONTEND] register - Password length: ${password.length}`);

        const requestBody = {
          email: email,
          password: password
        };

        // Adiciona full_name apenas se foi preenchido
        if (fullName.trim()) {
          requestBody.full_name = fullName;
        }

        console.log(`[FRONTEND] register - Request body:`, requestBody);

        const result = await makeRequest(`${getBaseUrl()}/auth/register`, {
          method: "POST",
          body: JSON.stringify(requestBody),
        });

        displayResponse("registerResponse", result.data, !result.success);
      }

      // Recomenda√ß√µes
      async function getUserRecommendations() {
        const userId = document.getElementById("userId").value;
        const limit = document.getElementById("userLimit").value;
        const strategy = document.getElementById("strategy").value;

        const url = `${getBaseUrl()}/recommendations/user/${userId}?limit=${limit}&strategy=${strategy}`;
        const result = await makeRequest(url);

        displayResponse(
          "userRecommendationsResponse",
          result.data,
          !result.success
        );
      }

      async function getPopularProducts() {
        const limit = document.getElementById("popularLimit").value;
        const state = document.getElementById("state").value;

        let url = `${getBaseUrl()}/recommendations/popular?limit=${limit}`;
        if (state) url += `&state=${state}`;

        const result = await makeRequest(url);
        displayResponse("popularResponse", result.data, !result.success);
      }

      async function getRelatedProducts() {
        const productId = document.getElementById("productId").value;
        const limit = document.getElementById("relatedLimit").value;

        const result = await makeRequest(
          `${getBaseUrl()}/recommendations/related/${productId}?limit=${limit}`
        );
        displayResponse("relatedResponse", result.data, !result.success);
      }

      async function getSeasonalRecommendations() {
        const month = document.getElementById("month").value;
        const limit = document.getElementById("seasonalLimit").value;

        const result = await makeRequest(
          `${getBaseUrl()}/recommendations/seasonal?month=${month}&limit=${limit}`
        );
        displayResponse("seasonalResponse", result.data, !result.success);
      }

      async function getTopRatedProducts() {
        const minReviews = document.getElementById("minReviews").value;
        const limit = document.getElementById("ratedLimit").value;

        const result = await makeRequest(
          `${getBaseUrl()}/recommendations/top-rated?min_reviews=${minReviews}&limit=${limit}`
        );
        displayResponse("topRatedResponse", result.data, !result.success);
      }

      // Analytics
      async function getMetrics() {
        const result = await makeRequest(`${getBaseUrl()}/analytics/metrics`);
        displayResponse("metricsResponse", result.data, !result.success);
      }

      async function getPopularCategories() {
        const result = await makeRequest(`${getBaseUrl()}/analytics/popular-categories`);
        displayResponse("categoriesResponse", result.data, !result.success);
      }

      async function getUserBehavior() {
        const userId = document.getElementById("behaviorUserId").value;
        const result = await makeRequest(`${getBaseUrl()}/analytics/user-behavior/${userId}`);
        displayResponse("behaviorResponse", result.data, !result.success);
      }

      // Sa√∫de
      async function checkHealth() {
        const result = await makeRequest(`${getBaseUrl()}/health`);
        displayResponse("healthResponse", result.data, !result.success);
      }

      // Inicializa√ß√£o
      document.addEventListener("DOMContentLoaded", function () {
        // Configura√ß√£o inicial se necess√°rio
      });
    </script>
  </body>
</html>
